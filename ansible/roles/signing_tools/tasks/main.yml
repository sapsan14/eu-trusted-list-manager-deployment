---
- name: Install signing tool packages (SoftHSM, OpenSC, pcsc)
  ansible.builtin.dnf:
    name:
      - softhsm
      - opensc
      - pcsc-lite
      - pcsc-lite-ccid
      - java-1.8.0-openjdk
      - unzip
      - wget
    state: present
  when: signing_tools_install_packages | bool

- name: Enable and start pcscd
  ansible.builtin.service:
    name: pcscd
    state: started
    enabled: true
  when: signing_tools_enable_pcscd | bool

- name: Ensure NexU install directory exists
  ansible.builtin.file:
    path: "{{ nexu_install_dir }}"
    state: directory
    mode: "0755"
  when: signing_tools_install_nexu | bool

- name: Fail if NexU URL not provided
  ansible.builtin.fail:
    msg: "Set nexu_download_url to the NexU release ZIP before running this role."
  when: signing_tools_install_nexu | bool and (nexu_download_url | length == 0)

- name: Download NexU release
  ansible.builtin.get_url:
    url: "{{ nexu_download_url }}"
    dest: "/tmp/nexu.zip"
    mode: "0644"
  when: signing_tools_install_nexu | bool and (nexu_download_url | length > 0)

- name: Unpack NexU release
  ansible.builtin.unarchive:
    src: "/tmp/nexu.zip"
    dest: "{{ nexu_install_dir }}"
    remote_src: true
  when: signing_tools_install_nexu | bool and (nexu_download_url | length > 0)

- name: Create NexU launcher symlink (best-effort)
  ansible.builtin.shell: |
    set -euo pipefail
    cand=$(find "{{ nexu_install_dir }}" -maxdepth 2 -type f -name "nexu*" -o -name "*.sh" | head -n 1 || true)
    if [ -n "$cand" ]; then
      ln -sf "$cand" "{{ nexu_bin_link }}"
    fi
  args:
    executable: /bin/bash
  when: signing_tools_install_nexu | bool and (nexu_download_url | length > 0)

- name: Create SoftHSM token (optional)
  ansible.builtin.shell: |
    set -euo pipefail
    softhsm2-util --init-token --free \
      --label "{{ softhsm_token_label }}" \
      --pin "{{ softhsm_user_pin }}" \
      --so-pin "{{ softhsm_so_pin }}"
  args:
    executable: /bin/bash
  when: softhsm_create_token | bool

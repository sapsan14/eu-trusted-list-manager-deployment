---
# Phase 2 Option A â€” Install Tomcat 9 from tarball
- name: Download Tomcat tarball
  ansible.builtin.get_url:
    url: "{{ tomcat_mirror }}/v{{ tomcat_version }}/bin/apache-tomcat-{{ tomcat_version }}.tar.gz"
    dest: /tmp/apache-tomcat-{{ tomcat_version }}.tar.gz
    mode: "0644"

- name: Unarchive Tomcat
  ansible.builtin.unarchive:
    src: /tmp/apache-tomcat-{{ tomcat_version }}.tar.gz
    dest: /opt
    remote_src: true
    creates: "/opt/apache-tomcat-{{ tomcat_version }}/bin/catalina.sh"

- name: Ensure /opt/tomcat symlink points to unpacked Tomcat
  ansible.builtin.file:
    src: "/opt/apache-tomcat-{{ tomcat_version }}"
    path: "{{ tomcat_install_dir }}"
    state: link
  when: tomcat_install_dir == "/opt/tomcat"
  notify: Restart Tomcat

- name: Set Tomcat directory ownership
  ansible.builtin.file:
    path: "/opt/apache-tomcat-{{ tomcat_version }}"
    state: directory
    owner: "{{ tomcat_user }}"
    group: "{{ tomcat_group }}"
    recurse: true

- name: Install MySQL connector JAR into Tomcat lib
  ansible.builtin.dnf:
    name: mysql-connector-java
    state: present
  register: _mysql_connector_installed
  ignore_errors: true

- name: Copy MySQL connector JAR to Tomcat lib (from RPM)
  ansible.builtin.copy:
    src: /usr/share/java/mysql-connector-java.jar
    dest: "{{ tomcat_install_dir }}/lib/mysql-connector-java.jar"
    owner: "{{ tomcat_user }}"
    group: "{{ tomcat_group }}"
    mode: "0644"
  when: _mysql_connector_installed is succeeded
  notify: Restart Tomcat

- name: Create Tomcat systemd service
  ansible.builtin.template:
    src: tomcat.service.j2
    dest: /etc/systemd/system/tomcat.service
    mode: "0644"

- name: Do not start Tomcat yet (WAR will be deployed first)
  ansible.builtin.systemd:
    daemon_reload: true
    name: tomcat
    enabled: true
    state: stopped


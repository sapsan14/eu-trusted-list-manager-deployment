---
# Phase 2 Option A â€” Install Tomcat 9 from tarball
- name: Download Tomcat tarball
  ansible.builtin.get_url:
    url: "{{ tomcat_mirror }}/v{{ tomcat_version }}/bin/apache-tomcat-{{ tomcat_version }}.tar.gz"
    dest: /tmp/apache-tomcat-{{ tomcat_version }}.tar.gz
    mode: "0644"

- name: Unarchive Tomcat
  ansible.builtin.unarchive:
    src: /tmp/apache-tomcat-{{ tomcat_version }}.tar.gz
    dest: /opt
    remote_src: true
    creates: "/opt/apache-tomcat-{{ tomcat_version }}/bin/catalina.sh"

- name: Ensure /opt/tomcat symlink points to unpacked Tomcat
  ansible.builtin.file:
    src: "/opt/apache-tomcat-{{ tomcat_version }}"
    path: "{{ tomcat_install_dir }}"
    state: link
  when: tomcat_install_dir == "/opt/tomcat"
  notify: Restart Tomcat

- name: Set Tomcat directory ownership
  ansible.builtin.file:
    path: "/opt/apache-tomcat-{{ tomcat_version }}"
    state: directory
    owner: "{{ tomcat_user }}"
    group: "{{ tomcat_group }}"
    recurse: true

- name: Create Tomcat HTTPS keystore (optional)
  ansible.builtin.command:
    cmd: >-
      keytool -genkeypair
      -alias {{ tomcat_https_key_alias }}
      -keyalg RSA
      -keysize 2048
      -storetype {{ tomcat_https_keystore_type }}
      -keystore {{ tomcat_https_keystore_path }}
      -validity 3650
      -storepass {{ tomcat_https_keystore_password }}
      -keypass {{ tomcat_https_key_password }}
      -dname "{{ tomcat_https_dname }}"
  args:
    creates: "{{ tomcat_https_keystore_path }}"
  when: tomcat_https_enabled and tomcat_https_generate_keystore

- name: Set HTTPS keystore ownership and permissions
  ansible.builtin.file:
    path: "{{ tomcat_https_keystore_path }}"
    owner: "{{ tomcat_user }}"
    group: "{{ tomcat_group }}"
    mode: "0640"
  when: tomcat_https_enabled

- name: Enable HTTPS connector in Tomcat server.xml
  ansible.builtin.blockinfile:
    path: "{{ tomcat_install_dir }}/conf/server.xml"
    marker: "<!-- {mark} ANSIBLE TOMCAT HTTPS -->"
    insertafter: "^\\s*<Connector port=\""
    block: |
      <Connector port="{{ tomcat_https_port }}" protocol="org.apache.coyote.http11.Http11NioProtocol"
                 maxThreads="150" SSLEnabled="true" scheme="https" secure="true">
        <SSLHostConfig>
          <Certificate certificateKeystoreFile="{{ tomcat_https_keystore_path }}"
                       certificateKeystorePassword="{{ tomcat_https_keystore_password }}"
                       type="RSA" />
        </SSLHostConfig>
      </Connector>
  when: tomcat_https_enabled
  notify: Restart Tomcat

- name: Install MySQL connector JAR into Tomcat lib
  ansible.builtin.dnf:
    name: mysql-connector-java
    state: present
  register: _mysql_connector_installed
  ignore_errors: true

- name: Copy MySQL connector JAR to Tomcat lib (from RPM)
  ansible.builtin.copy:
    src: /usr/share/java/mysql-connector-java.jar
    dest: "{{ tomcat_install_dir }}/lib/mysql-connector-java.jar"
    owner: "{{ tomcat_user }}"
    group: "{{ tomcat_group }}"
    mode: "0644"
  when: _mysql_connector_installed is succeeded
  notify: Restart Tomcat

- name: Create Tomcat systemd service
  ansible.builtin.template:
    src: tomcat.service.j2
    dest: /etc/systemd/system/tomcat.service
    mode: "0644"

- name: Do not start Tomcat yet (WAR will be deployed first)
  ansible.builtin.systemd:
    daemon_reload: true
    name: tomcat
    enabled: true
    state: stopped

